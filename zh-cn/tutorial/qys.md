# **QYS编写指南**

 QYS 是青云播放器支持的一种音乐文件格式。它是一种文本化的音乐格式，因此只需要使用文本编辑器（如记事本）就能高效地编写音乐。与此同时，青云播放器也将支持将 QYS 格式渲染为五线谱和简谱，方便阅读。

 QYS 格式它以简谱符号为基础，又同时融入了五线谱中的各种特殊符号，功能强大却又简单易学。如果你对简谱或五线谱有一定的了解，你将十分容易使用 QYS 来编写音乐。如果你没有使用过简谱或五线谱，这个由浅入深的指南也能让你很快明白编写 QYS 文件的方法。

 > 青云播放器也支持另一种文件格式：QYM。这两种文件格式的语法大多是相同的，对于不同之处，本文档会给出说明。QYM 与 QYS 的区别在于，QYM 格式在书写上更多地遵照五线谱和简谱中对各符号的规定，而 QYS 则更多地考虑到文本化的特点，设计了更多原创的符号和概念。要全面了解 QYM 格式，请参见[《QYM 编写手册》](http://qymp.ob-studio.cn/zh-cn/tutorial/qym)。

 - [音符与和弦](#音符与和弦)
 - [高级操作符](#高级操作符)
 - [音轨与格式](#音轨与格式)
 - [变量与函数](#变量与函数)

----------

## **快速上手**

 如果你想要快速掌握QYS的主要语法，下面的内容可以帮助你在短时间内对这种语言形成一个快速的认识。

 - [唱名与调名](#唱名与调名)
 - [音高操作符](#音高操作符)
 - [和弦](#和弦)
 - [时值操作符](#时值操作符)
 - [连音线](#连音线)
 - [小节号与换行符](#小节号与换行符)
 - [添加注释](#添加注释)
 - [基本变量声明](#基本变量声明)
 - [乐器的声明](#乐器的声明)

----------

## **音符与和弦**

 首先我们介绍音符的记法。在这一点上，QYS基本沿用了简谱的记号，因此相信只要是熟悉简谱的人都能快速学会QYS的音符记法。

### **唱名与调名**

 - 与简谱类似，用数字`1~7`分别代表唱名。
 - 与简谱类似，用数字`0`表示休止符。
 - 与简谱类似，用`<1=xx>`声明调名，比如说`<1=B>`。
 - `<1=bD>`和`<1=Db>`的表述都是可以接受的。
 
 范例：南京地铁到站提示音：`<1=C>3125`。

### **音高操作符**

 - 音高操作符写在一个音符或和弦的右侧，用于改变其音高。
 - 音高操作符共有4个，分别为`#`，`b`，`,`以及`'`。
 - `#`将一个音升高半度，`b`将一个音降低半度。
 - `'`将一个音升高八度，`,`将一个音降低八度。
 - 音高操作符允许叠加和交换，但仅对其左侧的音生效。
 - 符号`'`、`,`可以写到调名中，表示所有音统一升高、降低八度。

 范例：一个A大调下的音阶用C大调表示为`<1=C>671#'2'3'4#'5#'6'`，它等价于`<1=C'>6,7,1#234#5#6`。
   
 > QYM 语法中，`#`和`b`是前置的，`,`和`'`是后置的；而在QYS语法下，这四个操作符都是后置的。

### **和弦**

 - 用方括号`[]`表示一个和弦，方括号里面依次写入每一个音。
 - 一个音右侧的音高操作符将只改变这个音的音高。
 - 方括号右侧的音高操作符将改变每一个音的音高。
 - 对于一个和弦来说，我们推荐将各个音按从低到高的顺序写入，这样便于阅读。

 范例：一个和弦`[4#,6,1#]`，它等价于`[4#61'#],`。
 
 > QYM 中的和弦用&操作符来表示，如上面的例子在 QYM 中应写成`<1=bD>4,&6,&1`。

### **快速和弦记号**

 有一些固定的和弦被广泛使用，对此 QYS 提供了一些记号来快速地表示它们，称之为快速和弦记号。

 - 快速和弦记号的使用方法与音高操作符完全相同。将快速和弦记号写在根音（即最低的音）的右侧，就可以表示一个和弦。
 - 我们支持在`[]`内部使用快速和弦记号，如`[1M1']`等价于`[1351']`。
 - 每个音的右侧只允许使用不超过一个快速和弦记号，且`[]`右侧也不得使用快速和弦记号。
 - 目前支持的和弦记号如下表所示：

<table>
    <tr>
        <th>和弦记号</th>
        <th>和弦名称</th>
        <th>每个音与根音相差的半音</th>
    </tr>
    <tr>
        <td>M</td>
        <td>大三和弦</td>
        <td>0, 4, 7</td>
    </tr>
    <tr>
        <td>m</td>
        <td>小三和弦</td>
        <td>0, 3, 7</td>
    </tr>
    <tr>
        <td>a</td>
        <td>增三和弦</td>
        <td>0, 4, 8</td>
    </tr>
    <tr>
        <td>d</td>
        <td>减三和弦</td>
        <td>0, 3, 6</td>
    </tr>
    <tr>
        <td>o</td>
        <td>八度和弦</td>
        <td>0, 12</td>
    </tr>
    <tr>
        <td>p</td>
        <td>强力和弦</td>
        <td>0, 7, 12</td>
    </tr>
    <tr>
        <td>$</td>
        <td>自定义和弦</td>
        <td>由函数<code>&lt;Chord&gt;</code>给出</td>
    </tr>
</table>

 范例：一个和弦`5#d`，它等价于`[5#72']`。

 范例：一个自定义和弦`<Chord:0,4,7,12>4$`，它等价于`[461'4']`。
 
### **快速地表示前一个音**

 歌谱有时会出现一个音重复很多次的情况，为此 QYS 提供了符号`%`，用来表示前一个或几个音。

 - `%`表示向前数第n个音的音高，和弦将被看做一个整体。
 - 上述n是一个1到4之间的数，缺省值为1，由函数`<Trace:n>`定义。
 - `%`只复制音高，不复制时值。
 - `%`不复制打击乐，休止符和倚音。
 - `%`后可以继续使用音高操作符或快速和弦记号，以改变`%`的音高。

 范例：《Numb》的副歌部分：`<1=F>[61'#6']%%[52'5'][61'6']%%%[747'][53'5']`（未标注时值）。

 范例：《U.N.オーエンは彼女なのか?》的片段：`<1=F''><Chord:3>417b,%%%%%%%%%`（未标注时值）。

 > QYM 暂不支持这种用法。

### **时值操作符**

 - 时值操作符用于标记一个音的时值，位于音高操作符的右侧。
 - 时值操作符共有3个，分别是`-`，`_`，`.`以及顿音符号<code>&#96;</code>。
 - 当没有时值操作符时，默认为一拍。
 - `-`将时值增加一拍，`_`将时值减半。
 - 连续n个`.`的作用是将时值变为原来的(2-2^(-n))倍。
 - <code>&#96;</code>将时值缩短为其原时值的(1-r)倍，剩下的时值将自动用休止符补齐。
 - 上述参数r可以通过函数`<Stac:r>`声明，缺省值为1/2。
 - 时值操作符从左到右依次运算，其中<code>&#96;</code>的个数不能超过一个。

 > QYM 暂不支持顿音。

 范例：`0-..`占3.5拍，而`1.-_`占1.25拍。

 范例：<code>&lt;Stac:1/4&gt;2---&#96;</code>等价于`2--0`。

### **打击乐**

 - 打击乐用`x`表示，其中的休止符则仍用`0`来表示。
 - 时值操作符依旧适用，但只能用于改变两个音的间隔，不能用于改变一个音的长度。

### **实例**

 下面展示了《彩虹》的副歌部分。（部分格式不完整。）

```
<1=C'>0_5,_4_3_\
2_1_1_1_7,_1_2_3_|5,-0_5,_1_7,_|6,_5,_5,_4,_3,_2,_3,_4,_|5,-0_%_%_%_\
6,.6,_5#,_6,_7,_3,_|1-0_1_7,_1_|2.2_2_1_3_4_|2-0_5,_4#,_5,_\
3.3_4_3_2_7,_|1-0_1_7,_1_|5.5_4_3_2_3_|3-2_5,_4#,_5,_\
3.3_4_3_2_7,_|1_2_3_7_6.3_|5_4_3_4_32|1-|
```

**[回到页首](#QYS编写手册)**

----------

## **高级操作符**

 除了音符以外，钢琴谱中还使用了各种各样的其他记号，而 QYS 也提供了相应的处理方案。本章将依次介绍这些符号的用法。

 > 注意：若无特殊声明，本章内的`X`，`Y`均指一个音，`ABC`指若干个音，`n`指一个整数，`r`指一个实数。

### **前言**

在这一章中，我们将学习许多不同的操作符，于是如何将它们有序地组合在一起就成了一件重要的事情。为了便于理解，我们将这些操作符分为4类，它们分别是前置结构，核心结构，后置结构，以及跨音符操作符。

 - **核心结构**表达了一个音的音高。它是之前所述的唱名，和弦，`%`以及音高操作符的整体。
 - **前置结构**位于核心结构的左侧，用圆括号表示。如`(n-)`，`(n=)`，`(n~)`和`(ABC^)`。
 - **后置结构**位于核心结构的右侧，它就是之前所述的时值操作符`-`，`_`，`.`以及<code>&#96;</code>。
 - **跨音符操作符**位于两个音之间，包括`^`和`~`。
 - 在意义不相矛盾的前提下，每个结构内部的元素都是并列的，并且允许交换。

### **连音线**

 - 连音线用`^`表示。当`^`连接两个完全相同的音时，表示延长前一个音的时值。（在这种情况下，我们推荐使用`^%`的组合，这能让阅读者一目了然。）
 - 多个音之间的连音，应当在相邻每两个音之间都添加连音线。
 - 有关`^`的更多用法，参见[倚音](#倚音)章节。

  范例：之前的实例`1.-_`中，更符合乐谱规范的表示方法是`1__^%`。

### **n连音**

 - n连音用`(n~)ABC`表示，其功能为将之后的n个音符的时值变为原时值的(2^Floor[Log2[n]])/n倍。
 - 多连音的时值缩短效果对休止符也生效。
 - 应当注意到n连音与连音线混用时对时值产生的影响。比如`<4/4>(3~)XY^YZ-`共有4拍，而`<4/4>(3~)XY-Z-`只有10/3拍。
 
  范例：《月に叢雲華に風》第一句：`<1=bB>0-56|7b-7b2'|(3~)1'7b6^%-|1'-(3~)1'2'3b'|(3~)2'1'7b^%6`。

 > QYM 中n连音的语法是`(n)ABC`。

### **滑音**

 - 滑音用`X~Y`表示，其功能为将X到Y之间的所有音平均划分，将这些音以一拍的1/r为时值从X播放到Y，使得总时值为Y的时值。
 - 上述参数r可以通过函数`<Port:r>`声明，缺省值为6。
 - 滑音的时值完全等于Y的时值，与X的时值无关。（按照五线谱的规则，是应当把X的时值写成和Y一样。）
 - 滑音的第一个音一定是X，但最后一个音有可能不是Y。但无论最后一个音是不是Y，下次调用操作符`%`都将返回Y的音高。

  范例：《九月のパンプキン》主旋律最后一节：`3'_4'_3'_1'#_[62']5~7,b`。

### **震音**

 - 单震音用`(n-)X`表示，其功能为以一拍的2^(-n)为时值播放X，持续X的时值。
 - 双震音用`X(n=)Y`表示，其功能为以一拍的2^(-n)为时值，交替播放X和Y，持续Y的时值。
 - 双震音的时值完全等于Y的时值，与X的时值无关。（按照五线谱的规则，是应当把X的时值写成和Y一样。）
 - 使用双震音时，应确保时值能够平分给X和Y，否则会出现由于多放了一个Y而导致的时值稍长的情况。
 - 这里的n不仅可以是整数，还可以是表达式，如下面的范例2。

  范例1：《ラストリモート》片段：`7.1'#_(1-)2'-|(1-)1'#-(1-)2'-`

  范例2：《Gate of Steiner》片段：`3(Log[2,12]=)3'---`

### **倚音**

 - 倚音用`(ABC^)X`表示，其功能为快速播放A,B,C,...之后紧跟X。当ABC中不超过4个音时，每个音将播放r/4拍；否则这些音将平分r拍。这些音播放所占用的时值将从X的时值中扣除。
 - 上述参数r可以通过函数`<Appo:r>`声明，缺省值为1/4。
 - 琶音用`[ABC^X]`表示，它等价于`(A[AB][ABC]^)[ABCX]`。
 - 倚音支持ABC中包含和弦的情况，但琶音不允许ABC中包含和弦。
 - 和弦倚音右侧出现音高操作符时，将同和弦的用法一致，改变内部所有音的音高。

  范例1：《寂しい夜》主歌最后一小节：`3_4#_(7,34#^)5#-(4#5#7^)3'`。
  
  范例2：《宇宙を飛ぶ不思議な巫女》伴奏最后两小节：`[1#35#^1'#]--^|%--`

> QYM 中暂不支持琶音。

### **延长音**

 > QYS 中暂不支持延长音。如果您想要使用延长音，可以使用 QYM 语言。

### **实例**

下面展示了《ネクロファンタジア》的片段。（部分语法将在后面介绍。）

```    
<1=D><Dur:1>\
[41']-%%[61']-4'_5'_6'_1''_|[27]-%[572']7-5'_6'_7'\
1''_6'_3'_1'_7_1'_7_5_6_7,_3_7,_[24#6]-|1'74#'_5'_(3~)6'_4'_2'_7_4#_3_7,_6,_5,_4,\
[46]-%%4_6_1'_4'_6'_4'_1'_6_|[57]-%%7_2'_5'7_2'_5'\
[35#7]-5#'_2'_6'_2'_7'_2'_6'_2'_5#'_2'_0|[573']-.%-.%-^|%---4#,,,~1#---\
<1=C><Dur:0>\
[61'3'][131']'[137]'[72']_[573']_^|%-..[61'3']_^\
%[362']'[361']'[367]'_[361']'_^|%[37]'[136]'[135]'_[146]'_^\
%[15]'[13]'[135]'_[72'6']_^|%[72'5'][72'3'][72'5']_[573']_^\
%[572'][573'][575']_[573']_^|%_[73'](3=)5--[61'3']_^\
%[361']'[137]'[72']_[573']_^|%-..[61'3']_^\
%[362']'[361']'[367]'_[361']'_^|%[137]'[136]'[135]'_[146]'_^\
%[15]'[13]'[135]'_[72'6']_^|%[72'5'][72'3'][72'3'5']_[61#'3'6']_^\
%_3'-..(3=)1#'-..|3'-.(3=)1#'-.0|
```

**[回到页首](#QYS编写手册)**

----------

## **音轨与格式**

经过了上述两章的学习，我们已经基本能够完美地表现一首乐曲了。
接下来将介绍如何把这些记号写到 QYS 文件里。

### **小节号与换行符**

 - 与简谱类似，拍数用`<m/n>`声明。其中m表示一个小节的拍数，n表示以n分音符为一拍。
 - 与简谱类似，我们用`|`分隔两个相邻的小节。
 - 当已经完成了一个小节，且想要换行时，使用`\`换行。这里`\`充当了小节号，因此不必再次表明小节号了。
 - 请务必确保每个小节的拍数符合应有拍数，并确保没有在一个小节中间换行。如果相邻两个小节的拍数不同，应当在它们之间声明拍数。下面是一个例子（选自《ハルトマンの妖怪少女》的开头）：

```
<Harp><7/4><Dur:1>\
7532'.1'.2'7537b53b7b|7532'.1'.2'7537b53b7b\
5317.6.75315b3b1b5b|5317.6.75315b3b1b5b\
[57][35][7,3][72'].[61'].[72'][57][35][7,3][57b][3b5][7,3]b[57b]\
[57][35][7,3][72'].[61'].[72'][57][35][7,3][57b][3b5][7,3]b[57b]\
[35][13][5,1][57].[4#6].[57][35][13][5,1][35]b[13]b[5,1]b[35]b\
[35][13][5,1][57].[4#6].[57][35][13][5,1][35]b[13]b[5,1]b[35]b\
<4/4>\
373'-474'-|373'-474'-|4#1#'4#'-51#'5'-|4#1#'4#'-51#'5'-\
373'-474'-|373'-474'-|4#1#'4#'-51#'5'-|5#1#'5#'-62'6'-|
```

> QYM 暂不支持换行功能。

### **实音轨与空音轨**

 - 一个音轨由一次有效换行定义。以`\`结尾的换行不算做有效换行。空行也不算做有效换行。因此下面的程序段（选自《運命のダークサイド》的开头）实际上只包含一个音轨：

```
<1=bD><1.0><Dur:0>\
3.3_4.4_|4#.%_5.5_|[33']_%_%_%_[44']_%%_|[44']#_%_%_%_[55']_%%_\

<1=E><Dur:1>\
[16]3_6_7_1'_[72'][46]--%|[57]6_7_7_1'_7_5_[7,3].[7,6b].[6b3']|
```

 - 如果一个音轨内只包含函数声明（即所有内容都被`<>`包含），则称之为一个空音轨；否则称之为一个实音轨。
 - 有关实音轨和空音轨的作用，请参见[章节与子音轨](#章节与子音轨)章节。

### **章节与子音轨**

 当我们想要将一首乐曲分成几个部分依次播放时，不必在后面播放的音轨前加上无数的`0---`，我们只需采用章节功能就能完成这些。

 - 章节使用一个空音轨来声明，称为该章节的**头音轨**。头音轨中声明的量将作为该章节中所有音轨的缺省值，参见[作用域与缺省值](#作用域与缺省值)章节。
 - 同一章节内的所有音轨将同时开始播放，各个章节则按照顺序依次播放。
 - 当一个章节内各音轨的长度不完全相同时，程序会选择长度最长的音轨的长度作为该章节的长度。

 > QYM 中以空行作为章节的分界。

 - 子音轨用`{}`表示，表示里面的内容是外面内容的子音轨。子音轨允许不超过8重的嵌套。
 - 如果子音轨在一段乐谱的后面，应当在子音轨开始前写一条小节线。结束后则没有这个必要。
 - 子音轨最重要的作用在于其实现反复与反复跳跃的功能，参见[反复与反复跳跃](#反复与反复跳跃)章节。
 - 子音轨使用其所在音轨的当前参数作为该子音轨的缺省值，参见[作用域与缺省值](#作用域与缺省值)章节。
 - 子音轨内声明的函数将不会被带出子音轨。因此子音轨可以用来实现短暂的变量变化，比如下面的例子（选自《βίος》的开头）：

```
<Harp><1=bE><1.0>\
0---|0---|<Dur:2>0-5,05,1017,07,5,0-5,2|0-5,05,1017,07,5,0-5,2\
<Dur:1>652'5_1'2'5_2'5|652'5_1'2'5_2'5|652'5_1'2'5_2'5|652'5_1'2'5_2'2'_5'_\
<Dur:0>{<2/4>0-}\
[61'3'6']%,[1361']'[2562']'|[61'3'6']%,[1361']'[2562']'\
[361'3']'[6,136][51'3'5']'[61'3'6']'|[2572']'%,[1251']'[72'5'7']|
```

 > QYM 暂不支持子音轨。

### **反复与反复跳跃**

> 此功能的语法正在更新，故暂不开放。
> 想要使用反复和反复跳跃功能的，推荐使用QYM。

### **添加注释**

 - 我们推荐您在编写歌曲时留下您的注释，它能够让阅读者对于歌曲的信息一目了然。
 - 整行注释使用标记`//`，播放器将忽略其所在的整行。
 - 下面是一个使用注释的例子（选自《ネクロファンタジア》）：

        // Necro_Fantasia
        // 亡灵幻想曲 (ネクロファンタジア) 
        // composed by ZUN 
        // arranged by まらしぃ
        
        <4/4><170>
        
        //theme
        <Piano><1=E><0.8>\
        ......
        
        //accompaniment
        <Piano><1=E><0.6>\
        ......

**[回到页首](#QYS编写手册)**

----------

## **变量与函数**

QYS允许编写者使用`<>`命令调整乐曲的基本参数。
之前看到的`<1=C>`，`<4/4>`以及`<Stac:1/2>`就是一些例子。
本章将介绍`<>`命令的使用方法。

### **基本变量声明**

QYS中目前有4个基本变量，分别为调名，节拍，速度和音量。这四个变量的声明方法与其他的变量不同，故需要单独说明。我们以《運命のダークサイド》的伴奏第一段为例：

    <ElectricPiano><168><1=bD,><4/4><0.4><Dur:0>\
    :[3,6,3].%_[4,6,4].%_|[4#,6,4#].%_[5,6,5].%_:\

 - 调名由`<1=bD>`声明，它也可以等价地替换为`<1=#C>`，甚至`<1=Db>`也是可以接受的。允许在其中加入音高操作符`'`和`,`以改变整段乐谱的音高。建议将音高操作符加在调名的后面。缺省值为`<1=C>`。
 - 节拍由`<4/4>`声明。这两个数字会被播放器用来计算时值以及检查你的歌谱，因此请务必将每个小节按规范书写。缺省值为`<4/4>`。
 - 速度由`<168>`声明，它表示一分钟播放168拍。这里的数字一定要是正整数，如果写小数则不会被识别。缺省值为`<90>`。
 - 音量由`<0.4>`声明，它表示以标准音量的0.4播放。这里的数字一定要是小数，如果没有小数点则不会被识别。缺省值为`<1.0>`。
 - 调名，节拍和速度只对声明后的乐谱生效，而音量对整个音轨生效。

### **乐器的声明**

QYS支持直接在`<>`中声明使用的乐器。乐器对声明后的乐谱生效，因此一个音轨内部运行切换乐器。乐器名区分大小写。缺省值为`<Piano>`。

 - 目前QYS支持的普通乐器如下：

> Accordion, Agogo, AltoSax, Applause, Atmosphere, Bagpipe, Bandoneon, Banjo, BaritoneSax, Bass, BassAndLead, Bassoon, Bird, BlownBottle, Bowed, BrassSection, Breath, Brightness, BrightPiano, Calliope, Celesta, Cello, Charang,Chiff, Choir, Clarinet, Clavi, Contrabass, Crystal, DrawbarOrgan, Dulcimer, Echoes, ElectricBass, ElectricGrandPiano, ElectricGuitar, ElectricPiano, ElectricPiano2, EnglishHorn, Fiddle, Fifths, Flute, FrenchHorn, FretlessBass, FretNoise, Glockenspiel, Goblins, Guitar, GuitarDistorted, GuitarHarmonics, GuitarMuted, GuitarOverdriven, Gunshot, Halo, Harmonica, Harp, Harpsichord, Helicopter, HonkyTonkPiano, JazzGuitar, Kalimba, Koto, Marimba, MelodicTom, Metallic, MusicBox, MutedTrumpet, NewAge, Oboe, Ocarina, OrchestraHit, Organ, PanFlute, PercussiveOrgan, Piano, Piccolo, PickedBass, PizzicatoStrings, Polysynth, Rain, Recorder, ReedOrgan, ReverseCymbal, RockOrgan, Sawtooth, SciFi, Seashore, Shakuhachi, Shamisen, Shanai, Sitar, SlapBass, SlapBass2, SopranoSax, Soundtrack, Square, Steeldrums, SteelGuitar, Strings, Strings2, Sweep, SynthBass, SynthBass2, SynthBrass, SynthBrass2, SynthDrum, SynthStrings ,SynthStrings2, SynthVoice, Taiko, Telephone, TenorSax, Timpani, Tinklebell, TremoloStrings, Trombone, Trumpet, Tuba, TubularBells, Vibraphone, Viola, Violin, Voice, VoiceAahs, VoiceOohs, Warm, Whistle, Woodblock, Xylophone

 - 目前QYS支持的打击乐如下：

> BassDrum, BassDrum2, BellTree, Cabasa, Castanets, ChineseCymbal, Clap, Claves, Cowbell, CrashCymbal, CrashCymbal2, ElectricSnare, GuiroLong, GuiroShort, HighAgogo, HighBongo, HighCongaMute, HighCongaOpen, HighFloorTom, HighTimbale, HighTom, HighWoodblock, HiHatClosed, HiHatOpen, HiHatPedal, JingleBell, LowAgogo, LowBongo, LowConga, LowFloorTom, LowTimbale, LowTom, LowWoodblock, Maracas, MetronomeBell, MetronomeClick, MidTom, MidTom2, MuteCuica, MuteSurdo, MuteTriangle, OpenCuica, OpenSurdo, OpenTriangle, RideBell, RideCymbal, RideCymbal2, ScratchPull, ScratchPush, Shaker, SideStick, Slap, Snare, SplashCymbal, SquareClick, Sticks, Tambourine, Vibraslap, WhistleLong, WhistleShort

> QYM暂不支持打击乐。

### **函数是什么**

 - QYS中提供了各种各样的函数，而这些函数实质上仅承担为歌曲的一些参数赋值的作用。
 - QYS中任何的`<>`语句都是函数，但其中的一些允许被简化，比如`<180>`就是`<Speed:180>`的化简版。
 - 能被简化的函数包括上面提到的四个基本变量以及乐器。
 - 一些基本变量在简化的声明中会有一些限制，但在正常的函数声明中这些性质并不存在。比如`<1>`不能用于声明音量，但是`<1.0>`和`<Volume:1>`都可以。
 - 下面将介绍几个重要函数的使用。如果想要获得更多的使用方法，可以查看[函数一览表](#函数一览表)。

> QYM暂不支持函数的用法。
 
### **作用域与缺省值**

 - QYS中的所有变量都有缺省值。未声明之前的变量默认取缺省值。
 - 变量的作用域分为两种。第一种变量对所在音轨内声明处以后的乐谱生效；第二种变量对整个所在音轨生效。目前绝大部分变量属于第一类，因此我们只列出属于第二类的变量：

 > Volume(音量), FadeIn(淡入)，FadeOut(淡出)

 - 当音轨存在从属关系时，高级音轨中的变量的值将作为低级音轨中变量的缺省值。需要注意的是，整个歌谱中最高级的音轨是所有空音轨，应当认为它们是一个整体。因此前面的空音轨中声明的量将在后面的章节继续生效。下面是一个例子，选自《脳浆炸裂ガール》：

        //---------- Section 3 ----------
        <150><4/4><1=Bb>
        
        <Clarinet(0.7),Viola(1.0),Strings(0.4)>\
        <Dur:0>3'3'<Dur:2>2'2'2'1'2'2'2'1'|2'-3'-2'1'-6-----5-5\
        666-666666666665|666666663'-2'-2'-1'-\
        <Dur:0>3'3'<Dur:2>2'2'2'1'2'2'2'1'|2'-3'-2'1'-6-----5-5\
        666-666666666661'|2'2'2'1'2'2'2'1'2'-3'-5-6-^\
        <3/4><Dur:0>6--<FadeOut:0.7>|
        
        <ElectricGuitar(0.6),ElectricBass(0.8),Bass(0.8)><Oct:-1>\
        {[4,14]-[4,14]-3,[7,3]3,[7,3]|6,[36]6,[36]5,[25]5,[25]\
        4,[14]4,[14]3,[7,3]3,[7,3]|6,[36]6,[36]5,[25]5,[25]}:2|
        <3/4><Dur:0>0--|
        
        //---------- Section 4 ----------
        <3/4><1=Ab>

        <Piano><Oct:1><0.7>\
        0--|0--|0--|02_3_4_5_\
        71'5|2#-3|4-4#|5--\
        5,6,1|2-7,_6,_|4,_6,_1_2_3|7b--\
        01'1'|1'6_5_3b_3_|11'1'|1'6_5_3b_3_\
        <Dur:1>6,7b,7,11#2|2#344#55#|67b71'1#'2'|2#'3'4'4#'5'5#'|
        
        <ElectricBass(0.8),Bass(0.8)><Oct:-1>\
        {1[35][35]|5,[35][35]|1[35][35]|5,[35][35]}:5|

### **时值缩放**

当我们写一段快节奏的旋律时，不免会把曲子写成这样（选自《东方Project组曲串烧》）：

    <ElectricGrandPiano><1=C><4/4><140><0.8>\
    [25']__[22']__[25']_[24']__[22']__[24']_[12']__5__2'__5__[24']__1'__2'__5__\
    [47'b]__[46']__[44']_[47'b]_[46']_[24']2'_4'_\
    [25']__[22']__[25']_[24']__[22']__[24']_[12']__5__2'__5__[24']__1'__2'__5__\
    [25']_[24']_[22']_[25']_[24']_[22']_[25']\

大量的下划线会浪费写谱时间，并降低可读性。为此，QYS提供了时值缩放函数<Dur:n>用来解决这个问题。上述n的缺省值为0，而当使用了这个函数时，每个音符的时值将变为原来的2^(-n)倍。因此，上面的谱子可以写成：

    <ElectricGrandPiano><1=C><4/4><140><0.8><Dur:2>\
    [25'][22'][25']-[24'][22'][24']-[12']52'5[24']1'2'5\
    [47'b][46'][44']-[47'b]-[46']-[24']--2'-4'-\
    [25'][22'][25']-[24'][22'][24']-[12']52'5[24']1'2'5\
    [25']-[24']-[22']-[25']-[24']-[22']-[25']---\

### **八度升降**

在写低音谱或者高音谱的时候，我们时长需要大量地使用音高操作符`'`和`,`来升降8度。下面是一个例子（选自《幽雅に咲かせ、墨染の樱》的结尾部分，~~编曲的LittleRed非要用`<1=C>`我也没办法~~）：

    <1=C><4/4><144>
    
    <Violin>\
    [1#4#61#'].[4#62'4#'].[5#1#'5#']|[1#4#61#'].[4#62'4#'].[5#1#'5#']\
    [62'4'#6'][72'4'#7'][1#35#1'#]'[35#73']'|[1#4#61'#]'--[36]'_[37]'_\
    [1#4#61'#]'.[41'4']#.[1#4#61'#]'|[1#35#1'#]'.[41'4']#.[1#35#1'#]'\
    [62'4'#6'][72'4'#7'][1#35#1'#]'[35#73']'|[4#61'#4'#]'---||

    <Piano>\
    4,,#_1,#_4,#_6,_1#_4#_5#_1#_|3,,_5,,#_1,#_3,5,,#_3,_1,#_\
    2,,_6,,_2,_6,,_3,,_7,,_3,_7,,_|4,,#_1,#_4,#_6,_1#_4#_6\
    7,,,_4,,#_7,,_2,4,,#_2,_4,,#_|1,,#_5,,#_1,#_3,5,,#_3,_5,,#_\
    2,,_6,,_2,_6,,_3,,_7,,_3,_7,,_|(3~)4,,#_1,#_4,#_(3~)6,_1#_4#_(3~)6_1'#_4'#_(3~)6'_1''#_4''#_\

一种可能的解决方案是用形如<1=C,>的方式来设置八度的升降，下面我们给出另一种方法。QYS提供了八度升降函数`<Oct:n>`来设置八度的升降。上述n的缺省值为0。当使用了这个函数时，每个音符的音高将默认提高n个8度。于是上面的例子可以被写作：

    <1=C><4/4><144>
    
    <Violin>\
    [1#4#61#'].[4#62'4#'].[5#1#'5#']|[1#4#61#'].[4#62'4#'].[5#1#'5#']\
    <Oct:1>[6,24#6][7,24#7][1#35#1'#][35#73']|[1#4#61'#]--[36]_[37]_\
    [1#4#61'#].[4,14]#.[1#4#61'#]|[1#35#1'#].[4,14]#.[1#35#1'#]\
    [6,24#6][7,24#7][1#35#1'#][35#73']|[4#61'#4'#]---||

    <Piano>\
    <Oct:-1>4,#_1#_4#_6_1#'_4#'_5#'_1#'_|3,_5,#_1#_35,#_3_1#_\
    2,_6,_2_6,_3,_7,_3_7,_|4,#_1#_4#_6_1#'_4#'_6'\
    7,,_4,#_7,_24,#_2_4,#_|1,#_5,#_1#_35,#_3_5,#_\
    2,_6,_2_6,_3,_7,_3_7,_|(3~)4,#_1#_4#_(3~)6_1#'_4#_'<Oct:1>(3~)6,_1#_4#_(3~)6_1'#_4'#_||

> 注意：`<1=C,>`等价于`<Key:0><Oct:-1>`，因此调名会覆盖八度升降函数的效果。我们建议在多声部的头音轨声明<1=C>，然后在不同的音轨中使用不同的八度升降效果。

### **函数一览表**

下面的列表展示了QYS中所有函数的功能和缺省值。下面的列表中，`s`表示用双引号包含的字符串，`r`表示一个0到1之间的实数，`n`表示一个整数，`t`表示时间（以秒为单位）。

<table>
    <tr>
        <th>函数名</th>
        <th>函数功能</th>
        <th>作用方向</th>
        <th>缺省值</th>
    </tr>
    <tr>
        <td><code>&lt;Key:n&gt;</code></td>
        <td>设置基础音高n</td>
        <td>向后</td>
        <td>0</td>
    </tr>
    <tr>
        <td><code>&lt;Bar:n&gt;</code></td>
        <td>设置每小节的拍数n</td>
        <td>向后</td>
        <td>4</td>
    </tr>
    <tr>
        <td><code>&lt;Beat:n&gt;</code></td>
        <td>以n分音符为一拍</td>
        <td>向后</td>
        <td>4</td>
    </tr>
    <tr>
        <td><code>&lt;Speed:n&gt;</code></td>
        <td>设置速度n</td>
        <td>向后</td>
        <td>90</td>
    </tr>
    <tr>
        <td><code>&lt;Volume:r&gt;</code></td>
        <td>设置音量r</td>
        <td><b>前后</b></td>
        <td>1.0</td>
    </tr>
    <tr>
        <td><code>&lt;Instr:s&gt;</code></td>
        <td>设置乐器s</td>
        <td>向后</td>
        <td>"Piano"</td>
    </tr>
    <tr>
        <td><code>&lt;Stac:r&gt;</code></td>
        <td>调整<a href="#顿音">顿音</a>参数r</td>
        <td>向后</td>
        <td>1/2</td>
    </tr>
    <tr>
        <td><code>&lt;Port:n&gt;</code></td>
        <td>调整<a href="#滑音">滑音</a>参数n</td>
        <td>向后</td>
        <td>6</td>
    </tr>
    <tr>
        <td><code>&lt;Appo:t&gt;</code></td>
        <td>调整<a href="#倚音">倚音</a>参数t</td>
        <td>向后</td>
        <td>1/4</td>
    </tr>
    <tr>
        <td><code>&lt;Dur:r&gt;</code></td>
        <td>调整<a href="#时值缩放">时值缩放</a>参数r</td>
        <td>向后</td>
        <td>0</td>
    </tr>
    <tr>
        <td><code>&lt;Oct:r&gt;</code></td>
        <td>调整<a href="#八度升降">八度升降</a>参数r</td>
        <td>向后</td>
        <td>0</td>
    </tr>
    <tr>
        <td><code>&lt;FadeIn:t&gt;</code></td>
        <td>使音轨开头的t秒淡入</td>
        <td><b>前后</b></td>
        <td>2</td>
    </tr>
    <tr>
        <td><code>&lt;FadeOut:t&gt;</code></td>
        <td>使音轨最后的t秒淡出</td>
        <td><b>前后</b></td>
        <td>2</td>
    </tr>
</table>

**[回到页首](#QYS编写手册)**


